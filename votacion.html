<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Votaci√≥n Proyectos Sostenibles</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js "></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js "></script>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      margin: 0;
      background: #f4f6f9;
      color: #333;
    }
    header {
      background: #2c3e50;
      color: white;
      padding: 20px;
      text-align: center;
    }
    .container {
      max-width: 800px;
      margin: 20px auto;
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    h1 {
      margin-top: 0;
    }
    p.instructions {
      background: #e2f0ff;
      padding: 15px;
      border-left: 5px solid #3498db;
      margin-bottom: 20px;
      font-size: 1em;
      line-height: 1.5;
    }
    label {
      display: block;
      margin-top: 10px;
      font-weight: bold;
    }
    input[type="number"] {
      width: 60px;
      margin-left: 10px;
      padding: 5px;
      font-size: 1em;
    }
    textarea {
      width: 100%;
      height: 60px;
      margin-top: 5px;
      resize: vertical;
      padding: 10px;
      font-size: 1em;
    }
    select {
      width: 100%;
      padding: 8px;
      margin-top: 5px;
      font-size: 1em;
    }
    button {
      margin-top: 10px;
      padding: 10px 20px;
      background: #27ae60;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 1em;
    }
    button:hover {
      background: #219150;
    }
    .result {
      margin-top: 30px;
      background: #e9ffe8;
      padding: 15px;
      border: 1px solid #b2ffb1;
      border-radius: 10px;
    }
    .individual-result {
      margin-top: 20px;
      background: #fff;
      padding: 15px;
      border-radius: 10px;
      box-shadow: 0 0 5px rgba(0,0,0,0.1);
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 8px;
      text-align: center;
    }
    th {
      background-color: #f2f2f2;
    }
    .footer {
      text-align: center;
      padding: 20px;
      font-size: 0.9em;
      color: #aaa;
    }
  </style>
</head>
<body>

<header>
  <h1>üó≥Ô∏è Votaci√≥n de Proyectos Sostenibles</h1>
</header>

<div class="container">
  <h2>Instrucciones de Votaci√≥n</h2>
  <p class="instructions">
    Cada miembro del equipo debe seleccionar su nombre y evaluar todos los proyectos (incluyendo el propio) seg√∫n los siguientes criterios:
    <ul>
      <li><strong>Innovaci√≥n:</strong> ¬øQu√© tan original es el proyecto?</li>
      <li><strong>Viabilidad Econ√≥mica:</strong> ¬øEs sostenible desde el punto de vista financiero?</li>
      <li><strong>Impacto Ambiental:</strong> ¬øCu√°l es su beneficio para el medio ambiente?</li>
      <li><strong>Escalabilidad / Alcance:</strong> ¬øHasta qu√© punto puede extenderse o replicarse?</li>
      <li><strong>Comentario Final:</strong> Observaciones generales sobre el proyecto.</li>
    </ul>
    Usa una escala del <strong>1 al 10</strong>, donde <strong>1 = Muy bajo cumplimiento</strong> y <strong>10 = Alto cumplimiento</strong>.
  </p>

  <form id="voteForm">
    <label>
      Tu nombre:
      <select id="voter" required>
        <option value="">-- Selecciona tu nombre --</option>
        <option value="Daniel Jaramillo L√≥pez">Daniel Jaramillo L√≥pez</option>
        <option value="Diana Cecilia Benavides Surata">Diana Cecilia Benavides Surata</option>
        <option value="Luis Eduardo Mart√≠nez Garc√≠a">Luis Eduardo Mart√≠nez Garc√≠a</option>
        <option value="Maicol Duban Ni√±o Plazas">Maicol Duban Ni√±o Plazas</option>
      </select>
    </label>

    <!-- Daniel -->
    <h3>Proyecto: Reciclando y estudiando ANDO</h3>
    <label>Innovaci√≥n <input type="number" min="1" max="10" name="Daniel_I"></label>
    <label>Viabilidad Econ√≥mica <input type="number" min="1" max="10" name="Daniel_VE"></label>
    <label>Impacto Ambiental <input type="number" min="1" max="10" name="Daniel_IA"></label>
    <label>Escalabilidad / Alcance <input type="number" min="1" max="10" name="Daniel_EA"></label>
    <label>Comentario Final<textarea name="Daniel_C"></textarea></label>

    <!-- Diana -->
    <h3>Proyecto: R¬≥ Oficina (Reduce, Reutiliza, Recicla)</h3>
    <label>Innovaci√≥n <input type="number" min="1" max="10" name="Diana_I"></label>
    <label>Viabilidad Econ√≥mica <input type="number" min="1" max="10" name="Diana_VE"></label>
    <label>Impacto Ambiental <input type="number" min="1" max="10" name="Diana_IA"></label>
    <label>Escalabilidad / Alcance <input type="number" min="1" max="10" name="Diana_EA"></label>
    <label>Comentario Final<textarea name="Diana_C"></textarea></label>

    <!-- Luis -->
    <h3>Proyecto: M√≥dulos De Bienestar Costero "Caribe Limpio" - Piloto Playa Blanca</h3>
    <label>Innovaci√≥n <input type="number" min="1" max="10" name="Luis_I"></label>
    <label>Viabilidad Econ√≥mica <input type="number" min="1" max="10" name="Luis_VE"></label>
    <label>Impacto Ambiental <input type="number" min="1" max="10" name="Luis_IA"></label>
    <label>Escalabilidad / Alcance <input type="number" min="1" max="10" name="Luis_EA"></label>
    <label>Comentario Final<textarea name="Luis_C"></textarea></label>

    <!-- Maicol -->
    <h3>Proyecto: Reprogras aceites</h3>
    <label>Innovaci√≥n <input type="number" min="1" max="10" name="Maicol_I"></label>
    <label>Viabilidad Econ√≥mica <input type="number" min="1" max="10" name="Maicol_VE"></label>
    <label>Impacto Ambiental <input type="number" min="1" max="10" name="Maicol_IA"></label>
    <label>Escalabilidad / Alcance <input type="number" min="1" max="10" name="Maicol_EA"></label>
    <label>Comentario Final<textarea name="Maicol_C"></textarea></label>

    <button type="submit">Enviar Voto</button>
    <button type="button" onclick="downloadIndividualPDF()">Descargar Mi Evaluaci√≥n (PDF)</button>
  </form>

  <div id="individualResults"></div>
  <div id="results" class="result" style="display:none;"></div>
</div>

<div class="footer">
  &copy; 2025 | Sistema de Evaluaci√≥n de Proyectos Sostenibles
</div>

<script>
  const form = document.getElementById("voteForm");
  const resultsDiv = document.getElementById("results");
  const voterSelect = document.getElementById("voter");

  // Inicializar localStorage si no existe
  if (!localStorage.votes) {
    localStorage.votes = JSON.stringify({});
  }

  let currentVoter = null;

  voterSelect.addEventListener("change", () => {
    const selected = voterSelect.value;
    if (!selected) return;

    if (currentVoter && currentVoter !== selected) {
      alert("Ya has iniciado sesi√≥n como " + currentVoter + ". No puedes cambiar de usuario.");
      voterSelect.value = currentVoter;
      return;
    }

    if (confirm("¬øEst√°s seguro de que eres " + selected + "?")) {
      currentVoter = selected;
      lockOtherUsers();
    } else {
      voterSelect.value = "";
    }
  });

  function lockOtherUsers() {
    Array.from(voterSelect.options).forEach(opt => {
      if (opt.value !== currentVoter) {
        opt.disabled = true;
      }
    });
  }

  form.addEventListener("submit", function (e) {
    e.preventDefault();
    if (!currentVoter) return alert("Por favor, selecciona tu nombre.");

    const formData = new FormData(form);
    const votes = {};
    for (let [key, value] of formData.entries()) {
      if (key.includes("_")) {
        votes[key] = value;
      }
    }

    let allVotes = JSON.parse(localStorage.votes);
    allVotes[currentVoter] = votes;
    localStorage.votes = JSON.stringify(allVotes);

    alert(`‚úÖ Voto de ${currentVoter} guardado correctamente.`);
    showIndividualResult(currentVoter);
    checkAllVoted();
  });

  function checkAllVoted() {
    const names = [
      "Daniel Jaramillo L√≥pez",
      "Diana Cecilia Benavides Surata",
      "Luis Eduardo Mart√≠nez Garc√≠a",
      "Maicol Duban Ni√±o Plazas"
    ];
    const allVotes = JSON.parse(localStorage.votes || "{}");
    const voted = Object.keys(allVotes).length === names.length;

    if (voted) {
      calculateWinner();
    }
  }

  function calculateWinner() {
    const projects = {
      Daniel: { total: 0 },
      Diana: { total: 0 },
      Luis: { total: 0 },
      Maicol: { total: 0 }
    };

    const allVotes = JSON.parse(localStorage.votes);

    for (const voter in allVotes) {
      const vote = allVotes[voter];

      projects.Daniel.total += parseInt(vote["Daniel_I"] || 0) +
                               parseInt(vote["Daniel_VE"] || 0) +
                               parseInt(vote["Daniel_IA"] || 0) +
                               parseInt(vote["Daniel_EA"] || 0);

      projects.Diana.total += parseInt(vote["Diana_I"] || 0) +
                              parseInt(vote["Diana_VE"] || 0) +
                              parseInt(vote["Diana_IA"] || 0) +
                              parseInt(vote["Diana_EA"] || 0);

      projects.Luis.total += parseInt(vote["Luis_I"] || 0) +
                             parseInt(vote["Luis_VE"] || 0) +
                             parseInt(vote["Luis_IA"] || 0) +
                             parseInt(vote["Luis_EA"] || 0);

      projects.Maicol.total += parseInt(vote["Maicol_I"] || 0) +
                               parseInt(vote["Maicol_VE"] || 0) +
                               parseInt(vote["Maicol_IA"] || 0) +
                               parseInt(vote["Maicol_EA"] || 0);
    }

    const sorted = Object.entries(projects).sort((a, b) => b[1].total - a[1].total);

    let resultHtml = "<h2>üèÜ Resultados Finales:</h2>";
    resultHtml += "<table border='1' style='width:100%;border-collapse:collapse;text-align:center;'>"+
                  "<tr><th>Proyecto</th><th>Puntaje Total</th></tr>";

    sorted.forEach(([name, data]) => {
      resultHtml += `<tr><td>${name}</td><td>${data.total}</td></tr>`;
    });

    resultHtml += "</table>";
    resultHtml += `<h3 style="color:green;">‚úÖ Ganador: ${sorted[0][0]} con ${sorted[0][1].total} puntos.</h3>`;
    resultHtml += "<h3>üí¨ Comentarios finales:</h3>";

    for (const voter in allVotes) {
      const vote = allVotes[voter];
      resultHtml += `<strong>${voter}:</strong><br>`;
      resultHtml += `Reciclando y estudiando ANDO: ${vote["Daniel_C"]}<br>`;
      resultHtml += `R¬≥ Oficina: ${vote["Diana_C"]}<br>`;
      resultHtml += `Caribe Limpio: ${vote["Luis_C"]}<br>`;
      resultHtml += `Reprogras aceites: ${vote["Maicol_C"]}<br><br>`;
    }

    resultsDiv.innerHTML = resultHtml;
    resultsDiv.style.display = "block";
  }

  function showIndividualResult(voterName) {
    const allVotes = JSON.parse(localStorage.votes || "{}");
    const votes = allVotes[voterName];

    if (!votes) return;

    let html = `
      <div class="individual-result">
        <h2>üìÑ Tu Evaluaci√≥n - ${voterName}</h2>
        <table>
          <thead>
            <tr>
              <th>Proyecto</th>
              <th>Innovaci√≥n</th>
              <th>Viab. Econ√≥mica</th>
              <th>Impacto Ambiental</th>
              <th>Escalabilidad</th>
              <th>Comentario</th>
            </tr>
          </thead>
          <tbody>
    `;

    html += `<tr><td>Reciclando y estudiando ANDO</td><td>${votes["Daniel_I"] || "-"}</td><td>${votes["Daniel_VE"] || "-"}</td><td>${votes["Daniel_IA"] || "-"}</td><td>${votes["Daniel_EA"] || "-"}</td><td>${votes["Daniel_C"] || "-"}</td></tr>`;
    html += `<tr><td>R¬≥ Oficina</td><td>${votes["Diana_I"] || "-"}</td><td>${votes["Diana_VE"] || "-"}</td><td>${votes["Diana_IA"] || "-"}</td><td>${votes["Diana_EA"] || "-"}</td><td>${votes["Diana_C"] || "-"}</td></tr>`;
    html += `<tr><td>Caribe Limpio</td><td>${votes["Luis_I"] || "-"}</td><td>${votes["Luis_VE"] || "-"}</td><td>${votes["Luis_IA"] || "-"}</td><td>${votes["Luis_EA"] || "-"}</td><td>${votes["Luis_C"] || "-"}</td></tr>`;
    html += `<tr><td>Reprogras aceites</td><td>${votes["Maicol_I"] || "-"}</td><td>${votes["Maicol_VE"] || "-"}</td><td>${votes["Maicol_IA"] || "-"}</td><td>${votes["Maicol_EA"] || "-"}</td><td>${votes["Maicol_C"] || "-"}</td></tr>`;

    html += `</tbody></table></div>`;
    document.getElementById("individualResults").innerHTML = html;
  }

  async function downloadIndividualPDF() {
    const voter = currentVoter;
    if (!voter) {
      alert("‚ùå No has iniciado sesi√≥n.");
      return;
    }

    const element = document.querySelector(".individual-result");
    if (!element || !element.innerHTML.trim()) {
      alert("‚ùå No tienes datos para exportar.");
      return;
    }

    const canvas = await html2canvas(element);
    const imgData = canvas.toDataURL('image/png');
    const pdf = new jspdf.jsPDF();
    pdf.addImage(imgData, 'PNG', 10, 10);
    pdf.save(`Evaluacion_${voter.replace(" ", "_")}.pdf`);
  }
</script>

</body>
</html>
