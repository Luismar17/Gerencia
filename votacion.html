<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Votaci√≥n de Proyectos</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js "></script>
  <style>
    body { font-family: Arial; max-width: 700px; margin: auto; padding: 20px; }
    h2 { color: #2c3e50; }
    label { display: block; margin-top: 10px; font-weight: bold; }
    input[type="number"] { width: 60px; margin-left: 10px; }
    textarea { width: 100%; height: 60px; margin-top: 5px; }
    button { margin-top: 20px; padding: 10px 20px; background: #27ae60; color: white; border: none; cursor: pointer; }
    .result { margin-top: 30px; background: #e9ffe8; padding: 15px; border-radius: 10px; display: none; }
  </style>
</head>
<body>

<h2>üó≥Ô∏è Votaci√≥n de Proyectos Sostenibles</h2>

<form id="voteForm">
  <label>Tu nombre:
    <select id="nombre" required>
      <option value="">-- Selecciona --</option>
      <option value="Daniel Jaramillo L√≥pez">Daniel Jaramillo L√≥pez</option>
      <option value="Diana Cecilia Benavides Surata">Diana Cecilia Benavides Surata</option>
      <option value="Luis Eduardo Mart√≠nez Garc√≠a">Luis Eduardo Mart√≠nez Garc√≠a</option>
      <option value="Maicol Duban Ni√±o Plazas">Maicol Duban Ni√±o Plazas</option>
    </select>
  </label>

  <h3>Proyecto: Reciclando y estudiando ANDO</h3>
  <label>Innovaci√≥n <input type="number" min="1" max="10" id="Daniel_I"></label>
  <label>Viabilidad Econ√≥mica <input type="number" min="1" max="10" id="Daniel_VE"></label>
  <label>Impacto Ambiental <input type="number" min="1" max="10" id="Daniel_IA"></label>
  <label>Escalabilidad / Alcance <input type="number" min="1" max="10" id="Daniel_EA"></label>

  <h3>Proyecto: R¬≥ Oficina (Reduce, Reutiliza, Recicla)</h3>
  <label>Innovaci√≥n <input type="number" min="1" max="10" id="Diana_I"></label>
  <label>Viabilidad Econ√≥mica <input type="number" min="1" max="10" id="Diana_VE"></label>
  <label>Impacto Ambiental <input type="number" min="1" max="10" id="Diana_IA"></label>
  <label>Escalabilidad / Alcance <input type="number" min="1" max="10" id="Diana_EA"></label>

  <h3>Proyecto: M√≥dulos De Bienestar Costero "Caribe Limpio"</h3>
  <label>Innovaci√≥n <input type="number" min="1" max="10" id="Luis_I"></label>
  <label>Viabilidad Econ√≥mica <input type="number" min="1" max="10" id="Luis_VE"></label>
  <label>Impacto Ambiental <input type="number" min="1" max="10" id="Luis_IA"></label>
  <label>Escalabilidad / Alcance <input type="number" min="1" max="10" id="Luis_EA"></label>

  <h3>Proyecto: Reprogras aceites</h3>
  <label>Innovaci√≥n <input type="number" min="1" max="10" id="Maicol_I"></label>
  <label>Viabilidad Econ√≥mica <input type="number" min="1" max="10" id="Maicol_VE"></label>
  <label>Impacto Ambiental <input type="number" min="1" max="10" id="Maicol_IA"></label>
  <label>Escalabilidad / Alcance <input type="number" min="1" max="10" id="Maicol_EA"></label>

  <label>Comentario Final<textarea id="comentario"></textarea></label>
  <button type="submit">Enviar Voto</button>
</form>

<div id="results" class="result"></div>

<script>
  let ip = null;

  // Obtener direcci√≥n IP del usuario
  fetch("https://api.ipify.org ?format=json")
    .then(response => response.json())
    .then(data => ip = data.ip);

  document.getElementById("voteForm").addEventListener("submit", function(e) {
    e.preventDefault();

    if (!ip) return alert("Esperando a obtener tu direcci√≥n IP...");

    const nombre = document.getElementById("nombre").value;
    const payload = {
      nombre,
      ip,
      Daniel_I: document.getElementById("Daniel_I").value,
      Daniel_VE: document.getElementById("Daniel_VE").value,
      Daniel_IA: document.getElementById("Daniel_IA").value,
      Daniel_EA: document.getElementById("Daniel_EA").value,

      Diana_I: document.getElementById("Diana_I").value,
      Diana_VE: document.getElementById("Diana_VE").value,
      Diana_IA: document.getElementById("Diana_IA").value,
      Diana_EA: document.getElementById("Diana_EA").value,

      Luis_I: document.getElementById("Luis_I").value,
      Luis_VE: document.getElementById("Luis_VE").value,
      Luis_IA: document.getElementById("Luis_IA").value,
      Luis_EA: document.getElementById("Luis_EA").value,

      Maicol_I: document.getElementById("Maicol_I").value,
      Maicol_VE: document.getElementById("Maicol_VE").value,
      Maicol_IA: document.getElementById("Maicol_IA").value,
      Maicol_EA: document.getElementById("Maicol_EA").value,

      comentario: document.getElementById("comentario").value
    };

    fetch("https://script.google.com/macros/s/AKfycbza0yxZPzrD_DINVmQ3oQSyWDYKWsrC1kR8mfS5qJvso3Qjrvk6ndFKhXxpQyKx2xd2FQ/exec ", {
      method: "POST",
      body: JSON.stringify(payload)
    }).then(() => {
      alert("‚úÖ Voto enviado correctamente.");
      checkAllVoted();
    });
  });

  function checkAllVoted() {
    fetch("https://script.google.com/macros/s/AKfycbza0yxZPzrD_DINVmQ3oQSyWDYKWsrC1kR8mfS5qJvso3Qjrvk6ndFKhXxpQyKx2xd2FQ/exec?action=read")
      .then(res => res.json())
      .then(data => {
        const voters = [...new Set(data.map(row => row[2]))]; // Columna de IPs
        if (voters.length >= 4) {
          calculateWinner(data);
        }
      });
  }

  function calculateWinner(data) {
    const scores = {
      Daniel: 0,
      Diana: 0,
      Luis: 0,
      Maicol: 0
    };

    data.forEach(row => {
      scores.Daniel += parseInt(row[3]) + parseInt(row[4]) + parseInt(row[5]) + parseInt(row[6]);
      scores.Diana += parseInt(row[7]) + parseInt(row[8]) + parseInt(row[9]) + parseInt(row[10]);
      scores.Luis += parseInt(row[11]) + parseInt(row[12]) + parseInt(row[13]) + parseInt(row[14]);
      scores.Maicol += parseInt(row[15]) + parseInt(row[16]) + parseInt(row[17]) + parseInt(row[18]);
    });

    const sorted = Object.entries(scores).sort((a, b) => b[1] - a[1]);

    let html = "<h3>üèÜ Resultados Finales:</h3>";
    sorted.forEach(([name, score]) => {
      html += `<p><strong>${name}:</strong> ${score} puntos</p>`;
    });

    html += `<h3 style="color:green;">‚úÖ Ganador: ${sorted[0][0]} con ${sorted[0][1]} puntos.</h3>`;
    html += `<button onclick="generatePDF()">Descargar PDF</button>`;

    document.getElementById("results").innerHTML = html;
    document.getElementById("results").style.display = "block";
  }

  function generatePDF() {
    const doc = new jspdf.jsPDF();
    doc.text("Resultados de la Evaluaci√≥n de Proyectos", 20, 20);
    doc.text("Este documento fue generado autom√°ticamente.", 20, 30);

    const resultsDiv = document.getElementById("results");
    const lines = resultsDiv.innerText.split('\n');
    let y = 40;
    lines.forEach(line => {
      doc.text(line, 20, y);
      y += 10;
    });

    doc.save("resultados_votacion.pdf");
  }
</script>
</body>
</html>
