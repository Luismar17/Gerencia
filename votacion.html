<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Votaci√≥n Proyectos Sostenibles</title>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js "></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js "></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js "></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js "></script>
  <style>
    /* Aqu√≠ va todo el estilo del HTML anterior */
  </style>
</head>
<body>

<!-- Aqu√≠ va todo el contenido HTML del formulario que ya tienes -->

<script>
  // Configuraci√≥n Firebase
  const firebaseConfig = {
    apiKey: "TU_API_KEY",
    authDomain: "tu-proyecto.firebaseapp.com",
    databaseURL: "https://tu-proyecto.firebaseio.com ",
    projectId: "tu-proyecto",
    storageBucket: "tu-proyecto.appspot.com",
    messagingSenderId: "1234567890",
    appId: "1:1234567890:web:abc123xyz"
  };

  // Inicializar Firebase
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const database = firebase.database();

  // Autenticar an√≥nimamente
  auth.signInAnonymously().catch(function(error) {
    alert("Error al autenticarse");
  });

  // Obtener ID √∫nico del usuario an√≥nimo
  let userId = null;
  auth.onAuthStateChanged(user => {
    if (user) {
      userId = user.uid;
    }
  });

  // Manejar env√≠o del formulario
  document.getElementById("voteForm").addEventListener("submit", function(e) {
    e.preventDefault();

    const voter = document.getElementById("voter").value;
    if (!voter) return alert("Por favor selecciona tu nombre.");

    // Verificar si ya vot√≥ este usuario
    database.ref('votes/' + userId).once('value', snapshot => {
      if (snapshot.exists()) {
        alert("Ya has votado anteriormente.");
        return;
      }

      const formData = new FormData(document.getElementById("voteForm"));
      const votes = {};
      for (let [key, value] of formData.entries()) {
        votes[key] = value;
      }

      // Guardar voto con ID √∫nico
      database.ref('votes/' + userId).set({
        voter,
        votes,
        timestamp: Date.now()
      }).then(() => {
        alert("‚úÖ Voto guardado correctamente.");
        checkAllVoted();
      });
    });
  });

  function checkAllVoted() {
    database.ref('votes').on('value', snapshot => {
      const votes = snapshot.val() || {};
      const totalVotes = Object.keys(votes).length;

      if (totalVotes === 4) {
        calculateWinner(votes);
      }
    });
  }

  function calculateWinner(allVotes) {
    const projects = {
      Daniel: { total: 0 },
      Diana: { total: 0 },
      Luis: { total: 0 },
      Maicol: { total: 0 }
    };

    for (const id in allVotes) {
      const vote = allVotes[id].votes;

      projects.Daniel.total += parseInt(vote["Daniel_I"] || 0) +
                               parseInt(vote["Daniel_VE"] || 0) +
                               parseInt(vote["Daniel_IA"] || 0) +
                               parseInt(vote["Daniel_EA"] || 0);

      projects.Diana.total += parseInt(vote["Diana_I"] || 0) +
                              parseInt(vote["Diana_VE"] || 0) +
                              parseInt(vote["Diana_IA"] || 0) +
                              parseInt(vote["Diana_EA"] || 0);

      projects.Luis.total += parseInt(vote["Luis_I"] || 0) +
                             parseInt(vote["Luis_VE"] || 0) +
                             parseInt(vote["Luis_IA"] || 0) +
                             parseInt(vote["Luis_EA"] || 0);

      projects.Maicol.total += parseInt(vote["Maicol_I"] || 0) +
                               parseInt(vote["Maicol_VE"] || 0) +
                               parseInt(vote["Maicol_IA"] || 0) +
                               parseInt(vote["Maicol_EA"] || 0);
    }

    const sorted = Object.entries(projects).sort((a, b) => b[1].total - a[1].total);

    let resultHtml = "<h2>üèÜ Resultados Finales:</h2>";
    sorted.forEach(([name, data]) => {
      resultHtml += `<p><strong>${name}</strong>: ${data.total} puntos</p>`;
    });

    resultHtml += `<h3 style="color:green;">‚úÖ Ganador: ${sorted[0][0]} con ${sorted[0][1].total} puntos.</h3>`;
    resultHtml += `<button onclick="generatePDF()">Descargar PDF</button>`;

    document.getElementById("results").innerHTML = resultHtml;
    document.getElementById("results").style.display = "block";
  }

  function generatePDF() {
    const doc = new jspdf.jsPDF();
    doc.setFontSize(16);
    doc.text("Resultados de la Evaluaci√≥n de Proyectos", 20, 20);
    doc.setFontSize(12);
    doc.text("Este documento fue generado autom√°ticamente.", 20, 30);

    const resultsDiv = document.getElementById("results");
    const textLines = resultsDiv.innerText.split('\n');
    let y = 40;
    textLines.forEach(line => {
      doc.text(line, 20, y);
      y += 10;
    });

    doc.save("resultados_votacion.pdf");
  }
</script>

</body>
</html>
